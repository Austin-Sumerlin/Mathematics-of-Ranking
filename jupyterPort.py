gameFilename = 'NCAA_2025_Games.txt'
teamFilename = 'NCAA_2025_Teams.txt'
k = 0
import math


segmentWeighting = [1/2,1,2]

def weight_avg_spl(x:'team defeated'):
    return 3*math.log10(1/(avg_spl[x]-2))+1.75


avg_spl = {
  268: 3.487603305785124,
  30: 3.209366391184573,
  45: 3.068870523415978,
  238: 3.2920110192837466,
  16: 3.462809917355372,
  291: 3.278236914600551,
  322: 3.1983471074380163,
  89: 3.1019283746556474,
  137: 2.909090909090909,
  150: 3.484848484848485,
  223: 2.5234159779614327,
  145: 3.5674931129476586,
  200: 2.763085399449036,
  255: 3.1818181818181817,
  36: 3.2176308539944904,
  271: 3.1101928374655645,
  325: 2.647382920110193,
  46: 3.25068870523416,
  337: 3.206611570247934,
  311: 3.0,
  343: 3.393939393939394,
  260: 3.071625344352617,
  202: 2.6584022038567494,
  206: 3.37465564738292,
  56: 2.757575757575758,
  211: 3.303030303030303,
  32: 3.465564738292011,
  69: 3.256198347107438,
  227: 2.440771349862259,
  314: 3.077134986225895,
  99: 3.325068870523416,
  192: 3.74931129476584,
  276: 3.371900826446281,
  28: 3.347107438016529,
  15: 2.7327823691460056,
  3: 3.1349862258953167,
  106: 2.564738292011019,
  20: 2.581267217630854,
  10: 2.556473829201102,
  41: 4.25068870523416,
  26: 2.8484848484848486,
  49: 5.09366391184573,
  34: 2.68870523415978,
  180: 3.212121212121212,
  55: 2.7355371900826446,
  81: 3.716253443526171,
  76: 2.363636363636364,
  158: 3.2947658402203857,
  146: 3.0798898071625342,
  77: 2.8650137741046837,
  115: 2.46831955922865,
  130: 4.1652892561983474,
  121: 2.515151515151515,
  78: 3.765840220385675,
  128: 2.5068870523415976,
  186: 5.622589531680441,
  134: 2.479338842975207,
  117: 3.5895316804407718,
  139: 2.9173553719008263,
  8: 3.28099173553719,
  152: 2.4986225895316805,
  184: 3.465564738292011,
  163: 2.5289256198347108,
  159: 3.446280991735537,
  173: 2.435261707988981,
  51: 3.330578512396694,
  199: 2.5482093663911844,
  333: 3.553719008264463,
  210: 2.556473829201102,
  84: 2.9834710743801653,
  241: 2.4242424242424243,
  293: 3.5702479338842976,
  282: 2.669421487603306,
  194: 3.765840220385675,
  270: 2.6143250688705235,
  294: 3.3085399449035813,
  212: 3.15702479338843,
  272: 2.7520661157024797,
  292: 2.8677685950413223,
  142: 3.5950413223140494,
  295: 2.6391184573002757,
  92: 4.12396694214876,
  318: 2.5289256198347108,
  248: 3.6170798898071626,
  336: 2.6143250688705235,
  21: 3.696969696969697,
  340: 3.0192837465564737,
  70: 3.8292011019283754,
  346: 2.5950413223140494,
  59: 4.115702479338843,
  351: 2.5509641873278235,
  249: 3.184573002754821,
  50: 2.4545454545454546,
  44: 3.5041322314049586,
  239: 2.81267217630854,
  126: 3.4765840220385678,
  209: 3.137741046831956,
  2: 3.5867768595041323,
  37: 3.115702479338843,
  123: 3.74931129476584,
  108: 2.837465564738292,
  63: 3.9807162534435263,
  48: 2.5454545454545454,
  13: 4.62534435261708,
  328: 2.727272727272727,
  7: 4.223140495867769,
  52: 3.68870523415978,
  344: 3.43801652892562,
  53: 2.798898071625344,
  253: 3.1487603305785123,
  68: 2.5482093663911844,
  280: 3.7327823691460056,
  287: 2.652892561983471,
  71: 3.6170798898071626,
  228: 2.8980716253443526,
  330: 3.68870523415978,
  302: 3.074380165289256,
  80: 3.2975206611570247,
  245: 2.7796143250688705,
  88: 3.7024793388429753,
  171: 3.319559228650138,
  87: 4.008264462809917,
  91: 2.399449035812672,
  274: 2.975206611570248,
  281: 2.5730027548209367,
  95: 3.242424242424242,
  172: 3.1542699724517904,
  9: 3.1542699724517904,
  101: 2.6914600550964187,
  196: 3.5785123966942147,
  110: 3.4545454545454546,
  160: 3.43801652892562,
  357: 2.4242424242424243,
  114: 3.81267217630854,
  304: 3.556473829201102,
  122: 2.8264462809917354,
  90: 2.834710743801653,
  125: 3.165289256198347,
  133: 2.9807162534435263,
  221: 3.041322314049587,
  57: 3.234159779614325,
  154: 3.765840220385675,
  155: 2.716253443526171,
  47: 4.15426997245179,
  335: 2.5482093663911844,
  166: 4.509641873278237,
  98: 2.768595041322314,
  169: 3.8292011019283754,
  167: 2.382920110192837,
  178: 2.490358126721763,
  104: 3.440771349862259,
  19: 3.3057851239669422,
  174: 2.391184573002755,
  181: 3.184573002754821,
  324: 2.997245179063361,
  6: 3.658402203856749,
  94: 2.68870523415978,
  193: 3.471074380165289,
  230: 3.608815426997245,
  207: 3.900826446280992,
  234: 2.575757575757576,
  244: 3.269972451790633,
  348: 2.8980716253443526,
  236: 3.418732782369146,
  240: 2.831955922865014,
  43: 3.2920110192837466,
  363: 3.1101928374655645,
  243: 3.4986225895316805,
  296: 2.721763085399449,
  254: 3.669421487603306,
  261: 2.6556473829201104,
  283: 2.8539944903581267,
  284: 2.5041322314049586,
  306: 3.184573002754821,
  231: 2.669421487603306,
  24: 3.564738292011019,
  197: 2.8677685950413223,
  262: 4.121212121212121,
  273: 3.176308539944904,
  277: 3.5289256198347108,
  297: 2.37741046831956,
  100: 3.201101928374656,
  103: 2.5482093663911844,
  299: 3.68870523415978,
  222: 2.559228650137741,
  300: 2.5867768595041323,
  214: 3.1046831955922864,
  27: 3.5041322314049586,
  307: 3.060606060606061,
  305: 3.2479338842975207,
  29: 2.7520661157024797,
  264: 3.4765840220385678,
  144: 2.7851239669421486,
  334: 3.236914600550964,
  338: 2.7024793388429758,
  140: 3.757575757575758,
  354: 2.553719008264463,
  358: 2.90633608815427,
  224: 2.6997245179063363,
  352: 3.787878787878788,
  33: 3.721763085399449,
  225: 3.482093663911846,
  39: 2.8567493112947657,
  62: 3.2451790633608817,
  4: 2.363636363636364,
  321: 3.325068870523416,
  164: 3.071625344352617,
  201: 3.9173553719008254,
  362: 2.6942148760330578,
  310: 4.449035812672176,
  266: 2.975206611570248,
  285: 3.4931129476584024,
  161: 2.564738292011019,
  290: 3.426997245179064,
  72: 2.8650137741046837,
  275: 3.5371900826446283,
  217: 2.534435261707989,
  143: 3.652892561983471,
  127: 2.597796143250689,
  83: 3.774104683195592,
  317: 2.6115702479338845,
  301: 2.479338842975207,
  176: 2.4738292011019283,
  147: 3.490358126721763,
  177: 2.5234159779614327,
  350: 3.765840220385675,
  138: 2.391184573002755,
  360: 3.1790633608815426,
  252: 3.0275482093663912,
  165: 3.077134986225895,
  279: 2.68870523415978,
  64: 3.303030303030303,
  259: 2.746556473829201,
  38: 3.1955922865013773,
  246: 3.0991735537190084,
  93: 3.330578512396694,
  35: 2.559228650137741,
  42: 3.8457300275482096,
  135: 2.696969696969697,
  204: 3.8650137741046833,
  213: 2.7355371900826446,
  86: 3.253443526170799,
  11: 2.7300275482093666,
  119: 3.823691460055096,
  303: 2.5482093663911844,
  23: 3.4765840220385678,
  347: 2.743801652892562,
  312: 3.426997245179064,
  232: 3.1818181818181817,
  258: 2.71900826446281,
  315: 2.8484848484848486,
  14: 2.4931129476584024,
  124: 2.5371900826446283,
  269: 3.487603305785124,
  257: 3.716253443526171,
  339: 2.746556473829201,
  40: 3.393939393939394,
  329: 2.6170798898071626,
  112: 2.9366391184573004,
  61: 2.5922865013774103,
  265: 3.1460055096418733,
  102: 2.900826446280992,
  185: 3.765840220385675,
  25: 2.6143250688705235,
  220: 3.25068870523416,
  250: 2.650137741046832,
  345: 3.793388429752066,
  58: 2.6115702479338845,
  219: 2.74931129476584,
  289: 3.661157024793389,
  105: 2.7410468319559227,
  175: 2.606060606060606,
  226: 3.738292011019284,
  156: 2.771349862258953,
  319: 3.8732782369146,
  17: 2.303030303030303,
  132: 3.013774104683196,
  205: 3.8292011019283754,
  195: 3.716253443526171,
  198: 3.256198347107438,
  288: 4.099173553719008,
  73: 3.62534435261708,
  131: 3.256198347107438,
  118: 3.512396694214876,
  191: 2.878787878787879,
  183: 3.4545454545454546,
  216: 3.038567493112948,
  353: 3.1294765840220387,
  237: 5.005509641873278,
  349: 3.633608815426997,
  31: 3.4600550964187327,
  60: 3.049586776859504,
  256: 3.12396694214876,
  157: 3.382920110192837,
  298: 3.721763085399449,
  67: 2.90633608815427,
  313: 2.834710743801653,
  153: 2.9889807162534434,
  182: 3.5867768595041323,
  18: 3.1432506887052343,
  190: 3.512396694214876,
  79: 3.2589531680440773,
  85: 3.203856749311295,
  113: 2.950413223140496,
  187: 3.4049586776859506,
  148: 3.716253443526171,
  242: 3.4159779614325068,
  342: 3.9889807162534434,
  96: 3.7548209366391183,
  65: 4.027548209366391,
  109: 3.2644628099173554,
  129: 3.8953168044077136,
  97: 2.87603305785124,
  22: 2.950413223140496,
  229: 3.4765840220385678,
  189: 2.9366391184573004,
  355: 3.159779614325069,
  116: 3.884297520661157,
  308: 3.303030303030303,
  323: 2.997245179063361,
  286: 3.1487603305785123,
  120: 2.881542699724518,
  233: 3.2589531680440773,
  320: 3.5509641873278235,
  251: 3.743801652892562,
  107: 4.15426997245179,
  218: 3.5867768595041323,
  149: 3.1267217630854,
  208: 3.1515151515151514,
  316: 3.3112947658402203,
  235: 3.352617079889807,
  278: 3.5068870523415976,
  331: 3.071625344352617,
  332: 2.958677685950413,
  170: 3.3856749311294765,
  364: 3.347107438016529,
  309: 3.1790633608815426,
  151: 2.928374655647383,
  326: 3.2148760330578514,
  136: 2.8292011019283745,
  359: 3.115702479338843,
  82: 2.887052341597796,
  75: 3.173553719008265,
  54: 3.581267217630854,
  188: 2.928374655647383,
  1: 3.162534435261708,
  203: 2.9889807162534434,
  356: 3.303030303030303,
  12: 3.413223140495868,
  247: 3.256198347107438,
  66: 3.1955922865013773,
  162: 3.1432506887052343,
  341: 3.517906336088154,
  361: 3.1790633608815426,
  74: 2.6391184573002757,
  267: 3.355371900826446,
  111: 3.0964187327823693,
  263: 3.495867768595041,
  179: 3.088154269972452,
  141: 3.721763085399449,
  168: 3.5426997245179064,
  215: 3.6556473829201104,
  327: 3.0275482093663912,
  5: 4.4986225895316805,
}

    

# Will you use weighting? 
useWeighting = True 

import pandas as pd

teamNames = pd.read_csv(teamFilename, header = None)
numTeams = len(teamNames)
##### columns of games are:
#	column 0 = days since 1/1/0000
#	column 1 = date in YYYYMMDD format
#	column 2 = team1 index
#	column 3 = team1 homefield (1 = home, -1 = away, 0 = neutral)
#	column 4 = team1 score
#	column 5 = team2 index
#	column 6 = team2 homefield (1 = home, -1 = away, 0 = neutral)
#	column 7 = team2 score
games = pd.read_csv(gameFilename, header = None)
numGames = len(games)
import numpy as np
from math import ceil 

colleyMatrix = 2*np.diag(np.ones(numTeams))
b = np.ones(numTeams)

dayBeforeSeason = games.loc[0,0] - 1
lastDayOfSeason = games.loc[len(games)-1,0]

for i in range(numGames):
    team1ID = games.loc[i, 2] - 1 # subtracting 1 since python indexes at 0
    team1Score = games.loc[i, 4]
    team1Loc = games.loc[i, 3];

    team2ID = games.loc[i, 5] - 1 # subtracting 1 since python indexes at 0
    team2Score = games.loc[i, 7]
    team2Loc = games.loc[i, 6];
    
    currentDay = games.loc[i,0]

    # Find the weight for this game using time and home/away    
    if useWeighting:
        numberSegments = len(segmentWeighting)
        weightIndex = ceil(numberSegments*((currentDay-dayBeforeSeason)/(lastDayOfSeason-dayBeforeSeason))) - 1
        timeWeight = segmentWeighting[weightIndex]
    else:
        timeWeight = 1

    if team1Score > team2Score:  # Team 1 won 
        if team2ID in avg_spl:
            gameWeight=weight_avg_spl(team2ID)*timeWeight
            
    else:                        # Team 2 won
        if team1ID in avg_spl:
            gameWeight=weight_avg_spl(team1ID)*timeWeight
           
    
    # Update the Colley matrix and RHS
    colleyMatrix[team1ID, team2ID] -= gameWeight
    colleyMatrix[team2ID, team1ID] -= gameWeight

    colleyMatrix[team1ID, team1ID] += gameWeight
    colleyMatrix[team2ID, team2ID] += gameWeight
    
    if team1Score > team2Score:
        b[team1ID] += 1/2*gameWeight
        b[team2ID] -= 1/2*gameWeight
    elif team1Score < team2Score:
        b[team1ID] -= 1/2*gameWeight
        b[team2ID] += 1/2*gameWeight
    else:  # it is a tie and make 1/2 a win and 1/2 a loss for both teams
        b[team1ID] += 0; # this equates to adding nothing
        b[team2ID] += 0; # clearly this code could be deleted

r = np.linalg.solve(colleyMatrix,b)
iSort = np.argsort(-r)
print('\n\n************** COLLEY Rating Method **************\n')
print('===========================')
print('Rank   Rating    Team   ')
print('===========================')
if k==0:
    numberTeamToPrint = numTeams
else:        
    numberTeamToPrint = k 
for i in range(numberTeamToPrint):
    print(f'{i+1:4d}   {r[iSort[i]]:.5f}  {teamNames.loc[iSort[i],1]}')

print('')   # extra carriage return
numberCorrectPredictions = 0
for i in range(numGames):
    team1ID = games.loc[i, 2] - 1 
    team1Score = games.loc[i, 4]
    team2ID = games.loc[i, 5] - 1 
    team2Score = games.loc[i, 7]
    
    if team1Score > team2Score and r[team1ID] > r[team2ID]:
        numberCorrectPredictions += 1
    elif team2Score > team1Score and r[team2ID] > r[team1ID]:
        numberCorrectPredictions += 1
    elif team1Score == team2Score and r[team1ID] == r[team2ID]:
        numberCorrectPredictions += 1

print(f'Predictability: {numberCorrectPredictions/numGames*100:.2f}%') 
